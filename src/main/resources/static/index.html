<!DOCTYPE html>
<html lang="en">
<head>
    <title>Sectors</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="p-4">

<h3>Please enter your name and pick the Sectors you are currently involved in.</h3>

<form id="userForm">
    <div>
        <label for="name" class="form-label">Name:</label>
        <input type="text" id="name" class="form-control" required>
    </div>

    <div>
        <label for="sectors" class="form-label">Sectors:</label>
        <select id="sectors" class="form-select" size="15" required></select>
    </div>

    <div class="form-check">
        <input type="checkbox" class="form-check-input" id="termsCheckbox">
        <label class="form-check-label" for="termsCheckbox">
            Agree to terms
        </label>
    </div>

    <button type="submit" id="submitButton" class="btn btn-primary" disabled>Save</button>
</form>

<script>
    const submitButton = document.getElementById('submitButton');
    const termsCheckbox = document.getElementById('termsCheckbox');
    
    termsCheckbox.addEventListener('change', function() {
        submitButton.disabled = !this.checked;
    });

    async function getSectors() {
        fetch("/sectors", { 
            method: "GET"
        })
            .then(res => {
                if (!res.ok) throw new Error("Failed to load sectors");
                return res.json();
            })
            .then(sectors => {
                createForm(sectors);
                restoreFormData();
            })
            .catch(err => {
                console.error(err);
                alert("Error loading sectors.");
            });
    }

    function createForm(sectors) {
        const dropdown = document.getElementById('sectors');
        
        // set first parent sectors
        const roots = [];
        for (const sector of sectors) {
            if (sector.parentId === null) {
                roots.push(sector);
            }
        }
        
        for (const root of roots) {
            addOption(root, sectors, dropdown, 0);
        }
    }

    function addOption(sector, allSectors, select, depth) {
        const option = document.createElement('option');
        option.value = sector.id;
        
        let spaces = "";
        for (let i = 0; i < depth; i++) {
            spaces += " - ";
        }
        
        option.textContent = spaces + sector.name;
        select.appendChild(option);
        
        const children = [];
        for (const child of allSectors) {
            if (child.parentId === sector.id) {
                children.push(child);
            }
        }
        
        // dynamic recursion for children
        for (const child of children) {
            addOption(child, allSectors, select, depth + 1);
        }
    }

    function restoreFormData() {
        const userData = sessionStorage.getItem("userData");
        if (!userData) return;
        
        const data = JSON.parse(userData);
        
        // fill out name field with existing data
        const nameField = document.getElementById('name');
        nameField.value = data.name || "";
        
        const dropdown = document.getElementById('sectors');
        for (let i = 0; i < dropdown.options.length; i++) {
            const option = dropdown.options[i];
            const optionValue = parseInt(option.value);
            
            // pick last sector that was submitted to storage
            if (optionValue === data.sectorId) {
                option.selected = true;
                break;
            }
        }
    }

    function getUserData() {
        let data = {};
        const userData = sessionStorage.getItem("userData");

        // if first request, set sessionHash to empty string
        // otherwise get from sessionstorage
        if (userData) {
            data.sessionHash = JSON.parse(userData).sessionHash;
        } else {
            data.sessionHash = "";
        }

        data.name = document.getElementById('name').value.trim();
        data.sectorId = parseInt(document.getElementById('sectors').value);

        return data;
    }

    function saveUser(method) {
        const userData = getUserData();
        const jsonData = JSON.stringify(userData);

        fetch('/users', {
            method: method,
            headers: { "Content-Type": "application/json" },
            body: jsonData
        })
        .then(res => res.json())
        .then(json => {
            sessionStorage.setItem("userData", JSON.stringify({
                sessionHash: json.sessionHash,
                name: userData.name,
                sectorId: userData.sectorId
            }));

            alert(json.message || "Saved successfully!");
        })
    }

    document.getElementById('userForm').addEventListener('submit', e => {
        e.preventDefault();

        // probably not needed, but just in case
        if (!termsCheckbox.checked) {
            alert('Please agree to the terms and conditions.');
            return;
        }

        // POST if session just started, PUT if data has been sent during
        // current session and was saved to sessionStorage
        if (sessionStorage.getItem("userData")) {
            saveUser("PUT");
        } else {
            saveUser("POST");
        }
    });

    getSectors();
</script>

</body>
</html>